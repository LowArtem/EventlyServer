name: Deploy server configs

on:
  workflow_dispatch:
  push:
    branches: ["dev"] # TODO: должна быть master

jobs:
  test:
    uses: ./.github/workflows/test.yml@test


  # build:
  #   needs: test

  #   runs-on: ubuntu-latest
  #   environment: ci/cd

  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
  #       with:
  #         username: ${{ secrets.docker_username }}
  #         password: ${{ secrets.docker_password }}

  #     - name: Build and push Docker image
  #       uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
  #       with:
  #         context: ./EventlyServer
  #         push: true
  #         tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}:${{ secrets.IMAGE_VERSION }}


  deploy_configs:
    needs: test

    runs-on: ubuntu-latest
    environment: ci/cd

    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/ansible
        env:
          CI_DEPLOY_SSH_KEY: ${{ secrets.CI_DEPLOY_SSH_KEY }}
          GITHUB_WORKSPACE: $GITHUB_WORKSPACE
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}


  # TODO: заменить на ansible по возможности
  # send_hook:
  #   needs: build

  #   runs-on: ubuntu-latest
  #   environment: ci/cd

  #   steps:
  #     - name: Send request
  #       run: |
  #         curl -H "Authorization: Bearer ${{ secrets.WATCHTOWER_API_KEY }}" ${{ secrets.PROD_HOST }}:${{ secrets.WATCHTOWER_PORT }}/v1/update